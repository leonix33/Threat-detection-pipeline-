name: Build MSI Installer

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-msi:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
    
    - name: Download WiX Toolset
      run: |
        $wixUrl = "https://github.com/wixtoolset/wix3/releases/download/wix3141rtm/wix314-binaries.zip"
        $wixZip = "$env:TEMP\wix-binaries.zip"
        $wixDir = "$env:GITHUB_WORKSPACE\wix-tools"
        
        Write-Host "Downloading WiX Toolset..."
        Invoke-WebRequest -Uri $wixUrl -OutFile $wixZip
        
        Write-Host "Extracting WiX..."
        Expand-Archive -Path $wixZip -DestinationPath $wixDir -Force
        
        Write-Host "Adding WiX to PATH..."
        echo "$wixDir" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      shell: pwsh
    
    - name: Build MSI
      run: |
        cd installer
        msbuild PlatformToolkit.wixproj /p:Configuration=Release /p:Platform=x86
      shell: cmd
    
    - name: Upload MSI artifact
      uses: actions/upload-artifact@v4
      with:
        name: PlatformEngineerToolkit-MSI
        path: installer/bin/Release/PlatformEngineerToolkit_v1.0.0.msi
        if-no-files-found: error
